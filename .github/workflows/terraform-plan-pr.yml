name: "Terraform Plan (PR)"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
    paths:
      - 'modules/**'
      - 'azure-infra/**'
      - 'modules/self_service/**'

jobs:
  terraform-plan:
    name: Terraform Plan
    if: github.ref == 'refs/heads/main'   
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Terraform fmt check
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.6'
      - name: Check formatting
        run: |
          DIR="modules/self_service/examples"
          if [ ! -d "$DIR" ]; then DIR="."; fi
          cd "$DIR"
          terraform fmt -check -diff || true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.6'

      - name: Select working directory
        run: |
          if [ -d "modules/self_service/examples" ]; then echo "DIR=modules/self_service/examples" >> $GITHUB_ENV; else echo "DIR=." >> $GITHUB_ENV; fi

      - name: Terraform Init
        run: |
          cd "$DIR"
          terraform init -input=false

      - name: Terraform Plan
        run: |
          cd "$DIR"
          terraform plan -out=tfplan -input=false -no-color || true
          terraform show -no-color tfplan > plan.txt || true

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: |
            ${{ env.DIR }}/tfplan
            ${{ env.DIR }}/plan.txt

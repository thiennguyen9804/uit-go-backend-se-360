name: CI/CD

on:
  push:
    branches:
      - production  # Infrastructure deployment on production branch
    paths:
      # Infrastructure and Terraform changes
      - 'provision/**'
      - 'modules/**'
      - '.github/workflows/ci-cd.yml'
      # Build/test triggers (for entire solution)
      - '**/pom.xml'
      - '**/*.csproj'
      - 'uit-go-backend.sln'
  workflow_dispatch:
    # Manual trigger for infrastructure deployment

permissions:
  contents: read
  id-token: write

jobs:
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    env:
      DOTNET_VERSION: "8.0.x"
      JAVA_VERSION: "21"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore .NET dependencies
        run: dotnet restore uit-go-backend.sln

      - name: Build .NET solution
        run: dotnet build uit-go-backend.sln --configuration Release --no-restore

      - name: Test .NET solution
        run: dotnet test uit-go-backend.sln --configuration Release --no-build --logger trx

      - name: Setup Temurin JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      - name: Test Java services
        run: |
          set -euo pipefail
          for service in trip-service notification-service matching-service api-gateway; do
            echo "Running tests for $service"
            (cd "$service" && mvn -B -ntp clean test)
          done

  # ================================
  # PRODUCTION INFRASTRUCTURE DEPLOY
  # ================================     
  terraform-deploy:
    name: Terraform Deploy Infrastructure
    needs: build-test
    if: github.ref == 'refs/heads/production'
    runs-on: ubuntu-latest
    concurrency:
      group: terraform-deploy
      cancel-in-progress: false
    defaults:
      run:
        working-directory: provision/complete_demo
    env:
      ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
      ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
      ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
      ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
      TF_STATE_RESOURCE_GROUP: ${{ secrets.TF_STATE_RESOURCE_GROUP }}
      TF_STATE_STORAGE_ACCOUNT: ${{ secrets.TF_STATE_STORAGE_ACCOUNT }}
      TF_STATE_CONTAINER: ${{ secrets.TF_STATE_CONTAINER }}
      TF_STATE_KEY: ${{ secrets.TF_STATE_KEY }}
      TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Cache Terraform plugins
        uses: actions/cache@v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: terraform-${{ runner.os }}-${{ hashFiles('provision/complete_demo/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Verify backend configuration
        run: |
          missing=0
          for var in TF_STATE_RESOURCE_GROUP TF_STATE_STORAGE_ACCOUNT TF_STATE_CONTAINER TF_STATE_KEY; do
            if [ -z "${!var}" ]; then
              echo "::error ::Environment variable $var is required for Terraform remote state."
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            exit 1
          fi

      - name: Terraform Format
        run: terraform fmt -check -recursive

      - name: Terraform Init
        run: |
          terraform init -input=false \
            -backend-config="resource_group_name=${TF_STATE_RESOURCE_GROUP}" \
            -backend-config="storage_account_name=${TF_STATE_STORAGE_ACCOUNT}" \
            -backend-config="container_name=${TF_STATE_CONTAINER}" \
            -backend-config="key=${TF_STATE_KEY}"

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -out=tfplan

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: provision/complete_demo/tfplan

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

  # Note: Self-service deployment is now handled by deploy-service.yml workflow
  # This workflow only handles:
  # - build-test: Build and test entire solution
  # - terraform-deploy: Deploy infrastructure (provision/complete_demo)

